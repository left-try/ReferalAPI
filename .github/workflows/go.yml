name: API Test Workflow

on:
  push:
    branches:
      - master

jobs:
  api-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.20'  # Change to your Go version

      # Install dependencies
      - name: Install dependencies
        run: |
          go mod tidy

      # Start the Go server in the background
      - name: Start Go Server
        run: |
          nohup go run main.go

      # Previous API tests for signup and login
      - name: Sign Up Request
        run: |
          curl -X POST http://localhost:8000/signup \
          -H "Content-Type: application/json" \
          -d '{"email": "test@example.com", "password": "password123"}'

      - name: Login Request
        run: |
          curl -X POST http://localhost:8000/login \
          -H "Content-Type: application/json" \
          -d '{"email": "test@example.com", "password": "password123"}'

      # New API tests for referral codes
      - name: Create Referral Code
        run: |
          curl -X POST http://localhost:8000/create_code \
          -H "Content-Type: application/json" \
          -d '{"userId": 1}'

      - name: Sign Up by Referral Code
        run: |
          curl -X POST http://localhost:8000/signup_by_ref/1_referral_code \
          -H "Content-Type: application/json" \
          -d '{"email": "john.doe@example.com", "password": "password123"}'

      - name: Get Referral Code by Email
        run: |
          curl -X GET http://localhost:8000/get_code_by_email/test@example.com

      - name: Get Referrals
        run: |
          curl -X GET http://localhost:8000/get_referrals/1

      - name: Delete Referral Code
        run: |
          curl -X DELETE http://localhost:8000/delete_code/1_referral_code
